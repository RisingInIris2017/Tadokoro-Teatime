# 第三次课

- [第三次课](#第三次课)
  - [谐波平衡法与变换矩阵法](#谐波平衡法与变换矩阵法)
  - [谐波平衡方程的建立](#谐波平衡方程的建立)
    - [如何建模一个非线性二端网络构成的系统](#如何建模一个非线性二端网络构成的系统)
    - [将线性与非线性子网络解耦](#将线性与非线性子网络解耦)
    - [谐波平衡法的目标](#谐波平衡法的目标)
    - [线性方程组表示谐波平衡法](#线性方程组表示谐波平衡法)
      - [求解线性侧](#求解线性侧)
      - [求解非线性侧](#求解非线性侧)
      - [列写谐波平衡方程](#列写谐波平衡方程)
  - [求解谐波平衡方程](#求解谐波平衡方程)
    - [数值迭代法](#数值迭代法)
    - [分裂法](#分裂法)
    - [牛顿法](#牛顿法)
    - [反射法](#反射法)
  - [谐波截断阶数的选取](#谐波截断阶数的选取)
  - [变换矩阵法（大小信号法）](#变换矩阵法大小信号法)
    - [变换矩阵法的步骤](#变换矩阵法的步骤)
    - [变换矩阵](#变换矩阵)
    - [建立变换矩阵方程](#建立变换矩阵方程)
    - [变换矩阵方程的形式](#变换矩阵方程的形式)
  - [广义谐波平衡法](#广义谐波平衡法)
    - [求解方法](#求解方法)

## 谐波平衡法与变换矩阵法

前者分析单频信号激励的非线性电路。

包括功放、倍频器、带本振激励的混频器等。

后者分析两个频率激励的非线性电路。

包括混频器、调制器、参量放大器、参量上变频器等。

## 谐波平衡方程的建立

### 如何建模一个非线性二端网络构成的系统

1. 理想激励源
2. 源内阻/源电导
3. 输入匹配网络
4. 非线性二端网络
5. 输出匹配网络
6. 负载

除此之外还包括偏置电路，

即建模了一个完整的非线性二端网络构成的系统。

### 将线性与非线性子网络解耦

我们将线性器件（例如匹配和偏置等）放在一起，

非线性的 N 个器件放在一起，

使得线性子网络与非线性子网络解耦。

从而，非线性子网络变为一个有 N 个端口的网络。

在这种建模方式下，系统被建模为：

1. 理想激励源
2. 有源负载中的理想激励源
3. N+2 个端口的线性子网络（包含了源内阻抗/导纳与负载阻抗）
4. N 端口非线性子网络

多出来的 2 个端口是输入与负载。

### 谐波平衡法的目标

对线性子网络与非线性子网络相连的 N 个端口作分析，找到一组端口电压
$$V_1,V_2,...,V_N,\thinspace {\rm s.t.}\thinspace I_i+\hat{I}_i=0$$
式中 $I_i$ 是 i 端口向线性子网络方向的电流，$\hat{I}_i$ 是相同端口向非线性子网络方向的电流。

理论依据显然是 KCL：节点不能积累电流。

与此同时，由于器件非线性，$I_i$ 与 $\hat{I}_i$ 实质上各自是一个向量：
$$I_i=(I_{i0},I_{i1},I_{i2},...,I_{ik})$$

式中 k 代表谐波次数，k=0 为直流，

其最大值即为谐波截断的最高次数。

### 线性方程组表示谐波平衡法

#### 求解线性侧

据此，我们作出线性方程组
$$\mathbf I=\mathbf {YV}$$
其中
$$\mathbf I=(I_1,I_2,...,I_N,I_{N+1},I_{N+2})^{\rm T}$$
其中
$$I_i=(I_{i0},I_{i1},I_{i2},...I_{ik})^{\rm T}$$
同时，
$$\mathbf V=(V_1,V_2,...,V_N,V_{N+1},V_{N+2})^{\rm T}$$
其中
$$V_i=(V_{i0},V_{i1},V_{i2},...V_{ik})^{\rm T}$$
注意到 N+1 端口是源端口，

N+2 端口是负载端口，

那么源端口应当只有直流和一次谐波，其余分量为 0；

同时负载端口应当只有直流项，其余分量为 0；

更进一步地，可以拆分上述方程组：

$$\mathbf I=\mathbf Y(:,N+1:N+2)(V_{N+1},V_{N+2})^{\rm T}+\mathbf Y(:,1:N)(V_1,V_2,...,V_N)^{\rm T}$$

上式第一项具有电流的量纲，可以移项到等号的左边与 I 向量合并，

解此方程组，即得线性网络的参量。

#### 求解非线性侧

总体思路：抓住非线性电导的 VI 关系，或非线性电容的 QV 关系。

第一步：将端口电压从频域变换回时域。
$$F^{-1}\{V_n\}\rightarrow v_n(t)$$

第二步：从时域表示出非线性电容的电荷
$$q_n(t)=f(v_1(t),v_1(t),...,v_N(t))$$

第三步将电荷从时域变换到频域
$$F\{q_n(t)\}\rightarrow Q_n$$

这样，我们得到了频域的电荷向量
$$\mathbf Q=(Q_1,Q_2,...,Q_N,Q_{N+1},Q_{N+2})^{\rm T}$$
其中
$$Q_i=(Q_{i0},Q_{i1},Q_{i2},...Q_{ik})^{\rm T}$$

显然，我们可以对该矩阵的各元素时域求导，得到电流。

时域求导在频域就是乘以 $jk\omega$，k 是谐波次数。

我们可以用矩阵表示之：
$$\mathbf I_C=j\mathbf {\Omega Q}$$

式中的 $\mathbf \Omega$ 矩阵可写成 $\rm {diag}(\rm {Kron}(\rm {ones}(1,N),(\omega_1,\omega_2,...,\omega_k))$，

即主对角元重复 N 次 1-k 阶谐频数值的对角矩阵。

#### 列写谐波平衡方程

$$F(V)=I_S+Y_{N\times N}V+j\Omega Q+I_G=0$$

以上式中所有的量都是矩阵。

显然，它的解 $V=V_0$ 是一个 **频域的稳态解**，无法取得时域的瞬态解。

## 求解谐波平衡方程

### 数值迭代法

数值迭代，直至
$$F(V)F(V)^{\rm T} \leq \epsilon$$

### 分裂法

取 V 的初值，算出 $\hat{I}_N$,

令其为电流初值 $I^0$；

计算
$$V''=Z_{N\times N}(I^0-I_S)$$

估算
$$V^1=sV''+(1-s)V^0$$

再用新估算值计算电流的下一代值，

持续迭代，直至估算值与 $V''$ 的差值落在精度要求内。

这种方法物理概念清楚，容易编程；

但与此同时，s 给得大，收敛快，稳定性差易发散；

s 给得小，稳定性改善，但收敛慢。

> 一般取 s=0.2

### 牛顿法

任取一初值 $x_0$；

计算该点处函数的导数 $f'(x_0)$；

从而可以计算出该点处函数切线与 x 轴的交点与 $x_0$ 的距离
$$\Delta x = \frac{f(x_0)}{f'(x_0)}$$

用 $x_0-\Delta x$ 作为下一轮迭代初值，

迭代直至 $\Delta x$ 小于精度要求。

多元函数也有类似的迭代方法。

此种方法只要非线性不太强，初值合适，总可以收敛。

缺点是解方程和生成雅可比矩阵会产生时间和空间复杂度。

### 反射法

模拟真实电路的接通过程：端口电压从 0 开始反复迭代增加直至稳定。

1. 假想在每个端口都插入一段波长整数倍的微带线。
2. 假想一个很小的线性端口初始电压值 $v^0_n(t)$，它夹在非线性子网络的各端口，以后者为负载，从而形成非线性电流初值 $\hat{i}^0_n(t)$
3. 计算非线性子网络端口反射回来的反射波，并从时域变换到频域。
4. 求反射系数，与电压相量相乘
5. 反傅里叶变换回时域，与上一代相加得到下一代时域电压初值。

迭代，直至反射系数足够小。

![](../../images/2022-09-16-17-51-08.png)

![](../../images/2022-09-16-17-52-53.png)

## 谐波截断阶数的选取

1. 利用等效电路中的线性电容 C 与线性电导 G 来判断，若 $k\omega C>G$，认为该次谐波在电容 C 上相当于短路，可以忽略
2. 非线性强弱
3. 激励信号的大小
4. 根据求解问题的性质决定
   1. 倍频器要取两倍。
   2. 涉及 FFT 时要确保 2 的整数次幂。

## 变换矩阵法（大小信号法）

### 变换矩阵法的步骤

1. 先做大信号分析。此时可能会使用谐波平衡法。
2. 然后略去大信号，将一部分非线性元件替换为线性时变元件，做小信号分析。

### 变换矩阵

考虑电压激励由大小信号叠加组成 $$V_s(t)=V_P(t)+v(t)$$

式中 $$V_P(t) > 10v(t)$$

认为大信号项是不动的直流偏置，在大信号处对伏安关系作泰勒展开。

从而，小信号的伏安关系可以表示为
$$i(t)=\frac{{\rm d}f(V)}{{\rm d}V} \bigg |_{V=V_P}v(t)$$
微分项具有跨导的量纲，可以看作时变的跨导。

类似地，可以得到电容的小信号模型
$$q(t)=\frac{{\rm d}f(V)}{{\rm d}V} \bigg |_{V=V_P}v(t)$$

式中 $f(V)$ 是电荷-电压关系，那么相应的微分就具有电容的量纲，

可以看作时变的电容 $c(t)$，据此，对上式再对时间求导：
$$q'(t)=(\frac{{\rm d}f(V)}{{\rm d}V} \bigg |_{V=V_P}v(t))'=(c(t)v(t))'=cv'+c'v$$

类似可知，如果电容被两个电压控制，伏安关系会表现为 4 项求和：
$i=c_1v_1'+c_1'v_1+c_2v_2'+c_2'v_2$
两个时变电容来自电容-电压关系分别对两个电压求偏导数，

而上式中所有的导数都是对时间求导。

### 建立变换矩阵方程

通常，双频率激励的非线性元件上，混合频率为两个频率的线性组合；

但考虑大小信号条件，可以简化为
$$\omega_n=\omega_0+n\omega_p$$

从而，傅里叶展开电压电流：
$$v(t)=\sum^{+\infin}_{n=-\infin}V_n{\rm e}^{j\omega_nt} \\ i(t)=\sum^{+\infin}_{n=-\infin}I_n{\rm e}^{j\omega_nt}$$

跨导的波形也可以傅里叶展开，展开后由 $i=gv$ 欧姆定律，构建级数 Cauchy 乘积的形式。

据此我们得到矩阵：

![](../../images/2022-09-19-11-07-06.png)

### 变换矩阵方程的形式

$$I=GV \\ V=RI \\ I=j\Omega CV$$

上式中所有的大写字母都是矩阵，$\Omega={\rm diag}(\omega _{-N},\omega _{-(N-1)}, ...\omega _{N-1}, \omega _{N})$

自学应用看课本 3.2.2 及例 6。

## 广义谐波平衡法

修正狭义 HB：

1. 考虑全部的谐波组合分量。现在系统中的混合频率的确是两个激励频率的完整线性组合了。

### 求解方法

除反射法不能使用外，牛顿、分裂和优化三种方法仍可使用。

